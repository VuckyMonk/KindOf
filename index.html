<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Watch List</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #8b5cf6; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7c3aed; }
        /* Custom styling for the list items */
        .watched {
            opacity: 0.6;
            background-color: #111827;
        }
        .watched .item-title {
            text-decoration: line-through;
            font-style: italic;
        }
        /* Video Container to maintain 16:9 aspect ratio */
        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .active-view {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#111827',
                        'secondary-dark': '#1f2937',
                        'accent': '#8b5cf6',
                        'accent-hover': '#7c3aed',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8 font-sans">
    <div class="max-w-3xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-5xl sm:text-6xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-600">
                Realtime Watch List
            </h1>
            <!-- User ID and Status Display -->
            <div class="mt-2 text-sm text-gray-400 font-mono flex flex-wrap justify-center items-center gap-2">
                <span id="authStatus" class="font-bold text-yellow-500">Loading...</span>
                <span id="userIdDisplay">User ID: N/A</span>
                <button id="copyUidBtn" title="Copy User ID" class="text-gray-500 hover:text-accent transition duration-150 p-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2.5M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-3M16 17v-4m-4 4v-4m-4 4v-4" /></svg>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center mb-8 bg-secondary-dark rounded-xl p-2 shadow-xl border border-gray-700">
            <button id="listViewBtn" class="flex-1 py-3 px-4 text-lg font-semibold rounded-lg transition duration-200 text-white active-view">
                Watch Lists
            </button>
            <button id="linksViewBtn" class="flex-1 py-3 px-4 text-lg font-semibold rounded-lg transition duration-200 text-gray-400 hover:bg-gray-700">
                Video Links
            </button>
        </nav>

        <!-- Main Content Area -->
        <div id="contentArea">
            <div id="loadingIndicator" class="text-center text-gray-400 py-10">
                <svg class="animate-spin h-8 w-8 text-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Initializing database and authenticating...</p>
            </div>

            <!-- 1. List View (Default) -->
            <!-- CRITICAL FIX: Removed 'hidden' class so the structure is visible immediately -->
            <div id="listView"> 
                <!-- Input Form (Personal List) -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4">Add New Item (Personal)</h2>
                    <div class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="itemInput" placeholder="Enter item title (e.g., Chainsaw Man)" disabled
                               class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-accent focus:border-accent border-transparent transition duration-200 md:w-2/5 w-full disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="url" id="urlInput" placeholder="Paste watch link (Optional - YouTube preferred)" disabled
                               class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-accent focus:border-accent border-transparent transition duration-200 md:w-2/5 w-full disabled:opacity-50 disabled:cursor-not-allowed">
                        <button id="addItemBtn" disabled
                                class="bg-accent text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md transform md:w-1/5 w-full disabled:opacity-50 disabled:cursor-not-allowed hover:bg-accent-hover active:scale-[0.98]">
                            Add to List
                        </button>
                    </div>
                    <p id="messageBox" class="text-sm mt-3 h-5 text-red-400"></p>
                </div>

                <!-- Personal Watch List -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl border border-gray-700 mb-8">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-3">My Current Watch List (<span id="totalCount">0</span> Titles)</h2>
                    <ul id="itemList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <!-- Personal list items will be injected here -->
                    </ul>
                    <button id="clearAllBtn" disabled
                            class="mt-6 w-full py-2 text-sm text-red-400 border border-red-400 rounded-lg hover:bg-red-900/50 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        Clear All Personal List Items
                    </button>
                </div>

                <!-- Request & Suggestion Box (Public) -->
                <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-3 text-yellow-300">Public Watch Requests</h2>

                    <!-- Request Input Form -->
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <input type="text" id="requestInput" placeholder="Item to request (e.g., One Piece)" disabled
                               class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 border-transparent transition duration-200 sm:w-1/2 w-full disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="text" id="suggesterInput" placeholder="Your Name (Optional)" disabled
                               class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 border-transparent transition duration-200 sm:w-1/4 w-full disabled:opacity-50 disabled:cursor-not-allowed">
                        <button id="addRequestBtn" disabled
                                class="bg-yellow-500 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md transform sm:w-1/4 w-full disabled:opacity-50 disabled:cursor-not-allowed hover:bg-yellow-600 active:scale-[0.98]">
                            Suggest Item
                        </button>
                    </div>

                    <!-- Request List Header (Table Header) -->
                    <div class="grid grid-cols-12 text-sm font-bold text-gray-400 uppercase tracking-wider border-b border-gray-600 pb-2 mb-3">
                        <span class="col-span-6 md:col-span-7">Title</span>
                        <span class="col-span-4 md:col-span-3">Suggested By</span>
                        <span class="col-span-2 md:col-span-2 text-right">Action/Status</span>
                    </div>

                    <!-- Request List -->
                    <div id="requestList" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                        <!-- Suggested items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- 2. Video Links View -->
            <div id="videoLinksView" class="hidden">
                <div class="bg-secondary-dark p-6 rounded-xl shadow-2xl border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-3 text-cyan-300">My Saved Watch Links</h2>
                    
                    <!-- New Table Header for Links -->
                    <div class="grid grid-cols-12 text-sm font-bold text-gray-400 uppercase tracking-wider border-b border-gray-600 pb-2 mb-3">
                        <span class="col-span-5">Title</span>
                        <span class="col-span-4">Link</span>
                        <span class="col-span-3 text-right">Actions</span>
                    </div>
                    
                    <div id="linksContainer" class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Video links will be injected here -->
                    </div>
                </div>
            </div>
            
            <!-- 3. Video Player View (The "Next Page") -->
            <div id="videoPlayerView" class="hidden p-4 bg-secondary-dark rounded-xl shadow-2xl border border-gray-700">
                <!-- Content injected by renderPlayerView() -->
            </div>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, writeBatch, setDoc, getDocs, where, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ensure debug logging is enabled for better development experience
        setLogLevel('Debug');

        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let currentUserId = null;
        let personalList = [];
        let publicRequests = [];
        let isAuthReady = false;
        let currentView = 'list';
        let currentlyPlaying = null; // Stores the item object when video is playing

        // --- DOM Elements ---
        const itemInput = document.getElementById('itemInput');
        const urlInput = document.getElementById('urlInput');
        const itemListUl = document.getElementById('itemList');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const messageBox = document.getElementById('messageBox');
        const totalCount = document.getElementById('totalCount');
        const requestInput = document.getElementById('requestInput');
        const suggesterInput = document.getElementById('suggesterInput');
        const requestListUl = document.getElementById('requestList');
        const addRequestBtn = document.getElementById('addRequestBtn');
        
        // New Auth Display Elements
        const userIdDisplay = document.getElementById('userIdDisplay');
        const authStatusSpan = document.getElementById('authStatus');
        const copyUidBtn = document.getElementById('copyUidBtn');

        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // View Containers
        const listView = document.getElementById('listView');
        const videoLinksView = document.getElementById('videoLinksView');
        const videoPlayerView = document.getElementById('videoPlayerView');

        // Nav Buttons
        const listViewBtn = document.getElementById('listViewBtn');
        const linksViewBtn = document.getElementById('linksViewBtn');
        
        const linksContainer = document.getElementById('linksContainer');

        // --- Firebase Path Helpers ---
        function getPersonalListCollection() {
            if (!currentUserId) throw new Error("User not authenticated ($currentUserId is null). List item cannot be added.");
            // Path: /artifacts/{appId}/users/{userId}/personal_list
            return collection(db, 'artifacts', appId, 'users', currentUserId, 'personal_list');
        }

        function getPublicRequestsCollection() {
            // Path: /artifacts/{appId}/public/data/watch_requests
            return collection(db, 'artifacts', appId, 'public', 'data', 'watch_requests');
        }

        // --- Utility Functions ---

        function displayMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = isError ? 'text-sm mt-3 h-5 text-red-400' : 'text-sm mt-3 h-5 text-green-400';
            setTimeout(() => {
                messageBox.textContent = '';
            }, 3000);
        }
        
        function sanitizeUrl(url) {
            if (!url) return '';
            const trimmedUrl = url.trim();
            if (trimmedUrl.startsWith('http://') || trimmedUrl.startsWith('https://')) {
                return trimmedUrl;
            }
            // Simple default to https for user convenience
            return 'https://' + trimmedUrl;
        }
        
        // Function to extract YouTube video ID
        function extractYouTubeId(url) {
            // Regex to match various YouTube URL formats (watch, embed, shortener, etc.)
            const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return (match && match[1]) ? match[1] : null;
        }

        /**
         * Updates the User ID display and handles the copy functionality.
         * @param {string | null} uid The user's unique ID.
         * @param {boolean} isReady Authentication ready state.
         */
        function updateUserIdDisplay(uid, isReady) {
            if (isReady && uid) {
                authStatusSpan.textContent = "Ready";
                authStatusSpan.className = 'font-bold text-green-500';
                userIdDisplay.textContent = `User ID: ${uid}`;
                copyUidBtn.disabled = false;
                copyUidBtn.onclick = () => {
                    // document.execCommand('copy') is the reliable way in this environment
                    const tempInput = document.createElement('input');
                    document.body.appendChild(tempInput);
                    tempInput.value = uid;
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    displayMessage("User ID copied!", false);
                };
            } else {
                authStatusSpan.textContent = "Loading...";
                authStatusSpan.className = 'font-bold text-yellow-500';
                userIdDisplay.textContent = 'User ID: N/A';
                copyUidBtn.disabled = true;
            }
        }

        // --- Authentication Ready Handler ---
        function updateInteractiveElements(isEnabled) {
            // Personal List Inputs and Buttons
            itemInput.disabled = !isEnabled;
            urlInput.disabled = !isEnabled;
            addItemBtn.disabled = !isEnabled;
            clearAllBtn.disabled = !isEnabled; 
            
            // Public Request Inputs and Buttons
            requestInput.disabled = !isEnabled;
            suggesterInput.disabled = !isEnabled;
            addRequestBtn.disabled = !isEnabled;
            
            // Add/Remove visual cues
            const items = [addItemBtn, addRequestBtn, itemInput, urlInput, requestInput, suggesterInput, clearAllBtn];
            items.forEach(el => {
                el.classList.toggle('hover:bg-accent-hover', isEnabled && el.id === 'addItemBtn');
                el.classList.toggle('hover:bg-yellow-600', isEnabled && el.id === 'addRequestBtn');
                el.classList.toggle('opacity-50', !isEnabled);
                el.classList.toggle('cursor-not-allowed', !isEnabled);
            });
        }
        // --- View Switching Logic ---

        window.switchView = function(viewName) {
            currentView = viewName;

            // Toggle views visibility
            // listView is visible by default now (no 'hidden' class on load)
            listView.classList.toggle('hidden', currentView !== 'list');
            videoLinksView.classList.toggle('hidden', currentView !== 'links');
            videoPlayerView.classList.toggle('hidden', currentView !== 'player');

            // Hide nav when in player view
            document.querySelector('nav').classList.toggle('hidden', currentView === 'player');
            
            // Update button styles
            const activeClasses = ['bg-accent', 'active-view', 'text-white'];
            const inactiveClasses = ['text-gray-400', 'hover:bg-gray-700'];

            // Reset both buttons
            listViewBtn.classList.remove(...activeClasses);
            listViewBtn.classList.add(...inactiveClasses);
            linksViewBtn.classList.remove(...activeClasses);
            linksViewBtn.classList.add(...inactiveClasses);

            // Apply active styles
            if (currentView === 'list') {
                listViewBtn.classList.add(...activeClasses);
                listViewBtn.classList.remove(...inactiveClasses);
            } else if (currentView === 'links') {
                linksViewBtn.classList.add(...activeClasses);
                linksViewBtn.classList.remove(...inactiveClasses);
                renderVideoLinks(); // Ensure links are rendered when switching to this view
            }
            // No style update needed for 'player' view as the nav is hidden
        }

        // --- Personal List CRUD and Rendering ---

        function isItemInPersonalList(title) {
            return personalList.some(item => item.title.toLowerCase() === title.toLowerCase());
        }
        
        function createItemElement(item) { 
            const li = document.createElement('li');
            li.className = `flex items-center justify-between p-3 rounded-lg transition duration-200 shadow-md ${item.watched ? 'watched' : 'bg-gray-800 hover:bg-gray-700/80'}`;

            // Main Content container (Title + URL)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex flex-col flex-grow mr-4 min-w-0';

            // Item Title
            const titleSpan = document.createElement('span');
            titleSpan.className = 'item-title text-base sm:text-lg truncate'; 
            titleSpan.textContent = item.title;
            contentDiv.appendChild(titleSpan);

            // Item URL (Link)
            if (item.url) {
                const urlAnchor = document.createElement('a');
                const safeUrl = sanitizeUrl(item.url);
                
                urlAnchor.href = safeUrl;
                urlAnchor.target = '_blank';
                urlAnchor.rel = 'noopener noreferrer';
                const displayUrl = safeUrl.replace(/^(https?:\/\/(www\.)?)/, '').split('/')[0];

                urlAnchor.className = 'text-xs text-purple-400 hover:text-purple-300 truncate font-mono';
                urlAnchor.textContent = 'Link: ' + displayUrl;
                contentDiv.appendChild(urlAnchor);
            }

            li.appendChild(contentDiv);

            // Action Buttons Container
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex space-x-2 shrink-0';

            // Watched Toggle Button
            const toggleBtn = document.createElement('button');
            toggleBtn.innerHTML = item.watched
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
            toggleBtn.title = item.watched ? 'Mark as Unwatched' : 'Mark as Watched';
            toggleBtn.className = 'p-1 rounded-full transition duration-150';
            toggleBtn.onclick = () => toggleWatched(item.id, item.title, !item.watched);
            actionsDiv.appendChild(toggleBtn);

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
            deleteBtn.title = 'Delete';
            deleteBtn.className = 'p-1 rounded-full transition duration-150';
            deleteBtn.onclick = () => deleteItem(item.id, item.title); 
            actionsDiv.appendChild(deleteBtn);

            li.appendChild(actionsDiv);
            return li;
        }

        function renderList() {
            itemListUl.innerHTML = '';
            totalCount.textContent = personalList.length;

            // Sort list: unwatched first, then watched
            const sortedList = [...personalList].sort((a, b) => {
                if (a.watched === b.watched) return 0;
                if (a.watched) return 1; 
                return -1; 
            });

            if (sortedList.length === 0) {
                itemListUl.innerHTML = `<li class="text-center text-gray-500 py-6">Your watch list is empty! Add your first item above.</li>`;
                // Only hide the clear button if the list is truly empty
                clearAllBtn.classList.add('hidden');
            } else {
                // Show the clear button when items exist
                clearAllBtn.classList.remove('hidden');
                sortedList.forEach(item => {
                    const element = createItemElement(item); 
                    itemListUl.appendChild(element); 
                });
            }
            
            // If the links view is active, update it (needed in case of a list change)
            if (currentView === 'links') {
                renderVideoLinks();
            }
        }

        async function addItem() { 
            if (!isAuthReady) { 
                displayMessage("Authentication not ready. Please wait until 'Ready' status is shown.", true); 
                return; 
            }
            
            const title = itemInput.value.trim(); 
            const url = urlInput.value.trim(); 
            
            if (title === '') {
                displayMessage("Item title cannot be empty.", true);
                return;
            }

            const exists = personalList.some(item => item.title.toLowerCase() === title.toLowerCase());
            if (exists) {
                displayMessage(`'${title}' is already in your personal list.`, true);
                return;
            }

            try {
                // Ensure currentUserId is set before attempting to get collection reference
                if (!currentUserId) {
                    throw new Error("User ID not available during addDoc call. Auth state is inconsistent.");
                }

                await addDoc(getPersonalListCollection(), {
                    title: title,
                    url: url,
                    watched: false,
                    createdAt: Date.now()
                });
                
                itemInput.value = ''; 
                urlInput.value = ''; 
                displayMessage(`'${title}' added to personal list!`);
            } catch (error) {
                // CRITICAL: Log the full error object for better debugging
                console.error("FIREBASE ERROR: Failed to add item. Check permissions/path:", error);
                displayMessage("Failed to add item. Check browser console for details (FIREBASE ERROR).", true);
            }
        }

        async function toggleWatched(docId, title, newWatchedStatus) {
            if (!isAuthReady) return;
            try {
                const itemRef = doc(getPersonalListCollection(), docId);
                await updateDoc(itemRef, { watched: newWatchedStatus });
                displayMessage(newWatchedStatus ? `'${title}' marked as watched.` : `'${title}' marked as unwatched.`);
            } catch (error) {
                console.error("Error toggling watched status:", error);
                displayMessage("Failed to update status. Check console.", true);
            }
        }

        async function deleteItem(docId, title) { 
            if (!isAuthReady) return;
            try {
                await deleteDoc(doc(getPersonalListCollection(), docId));
                displayMessage(`'${title}' removed from your personal list.`);
            } catch (error) {
                console.error("Error deleting item:", error);
                displayMessage("Failed to delete item. Check console.", true);
            }
        }

        async function clearAll() {
            if (!isAuthReady || personalList.length === 0) return;

            const confirmation = prompt("To clear your entire personal list, please type 'DELETE ALL' to confirm. This action cannot be undone.");

            if (confirmation === 'DELETE ALL') {
                try {
                    const batch = writeBatch(db);
                    personalList.forEach(item => {
                        batch.delete(doc(getPersonalListCollection(), item.id));
                    });
                    await batch.commit();
                    displayMessage("Personal list cleared successfully.");
                } catch (error) {
                    console.error("Error clearing all items:", error);
                    displayMessage("Failed to clear all items. Check console.", true);
                }
            } else {
                displayMessage("Clear operation cancelled or incorrect confirmation.", true);
            }
        }

        // --- Public Requests CRUD and Rendering ---

        function createRequestElement(request) {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 items-center bg-gray-800 hover:bg-gray-700/80 p-3 rounded-lg transition duration-200';

            // Title
            const titleSpan = document.createElement('span');
            titleSpan.className = 'col-span-6 md:col-span-7 text-sm font-semibold truncate';
            titleSpan.textContent = request.title;

            // Suggester Name
            const nameSpan = document.createElement('span');
            nameSpan.className = 'col-span-4 md:col-span-3 text-xs text-gray-400 truncate';
            nameSpan.textContent = request.suggestedBy || 'Anonymous';

            // Action / Status Indicator
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'col-span-2 md:col-span-2 text-right';
            
            const isListed = isItemInPersonalList(request.title); 

            if (isListed) {
                // Renders a green checkmark if it's already added to the personal list
                const listedIcon = document.createElement('span');
                listedIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                listedIcon.title = 'Already in My Watch List';
                actionsDiv.appendChild(listedIcon);
            } else {
                // Renders the 'Add' button if it's not yet listed
                const addToListBtn = document.createElement('button');
                addToListBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-accent inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>`;
                addToListBtn.title = 'Add to My Watch List';
                addToListBtn.className = 'p-1 rounded-full transition duration-150';
                addToListBtn.onclick = () => moveRequestToPersonal(request.id, request.title);
                actionsDiv.appendChild(addToListBtn);
            }

            div.appendChild(titleSpan);
            div.appendChild(nameSpan);
            div.appendChild(actionsDiv);

            return div;
        }

        function renderRequests() {
            requestListUl.innerHTML = '';
            
            if (publicRequests.length === 0) {
                requestListUl.innerHTML = `<div class="text-center text-gray-500 py-6">No public suggestions yet!</div>`;
                return;
            }
            
            // Sort by creation time (newest first)
            const sortedRequests = [...publicRequests].sort((a, b) => b.createdAt - a.createdAt);

            sortedRequests.forEach(request => {
                const item = createRequestElement(request);
                requestListUl.appendChild(item);
            });
        }

        async function addRequest() {
            if (!isAuthReady) { displayMessage("Authentication not ready. Please wait.", true); return; }
            
            const title = requestInput.value.trim();
            const suggester = suggesterInput.value.trim() || 'Anonymous';

            if (title === '') {
                displayMessage("Request title cannot be empty.", true);
                return;
            }

            // Client-side check for request duplicates
            const exists = publicRequests.some(request => request.title.toLowerCase() === title.toLowerCase());
            if (exists) {
                displayMessage(`'${title}' has already been suggested.`, true);
                return;
            }
            
            try {
                await addDoc(getPublicRequestsCollection(), {
                    title: title,
                    suggestedBy: suggester,
                    createdAt: Date.now()
                });

                requestInput.value = '';
                suggesterInput.value = '';
                displayMessage(`Suggestion '${title}' added!`);
            } catch (error) {
                console.error("Error adding request:", error);
                displayMessage("Failed to add request. Check console.", true);
            }
        }

        async function moveRequestToPersonal(requestId, title) {
            if (!isAuthReady) return;
            
            const alreadyInPersonal = personalList.some(item => item.title.toLowerCase() === title.toLowerCase());

            if (alreadyInPersonal) {
                displayMessage(`'${title}' is already in your personal list. Removing request only.`, true);
            } else {
                try {
                    // 1. Add to personal list
                    await addDoc(getPersonalListCollection(), {
                        title: title,
                        url: '', // Default to empty URL when moving from request
                        watched: false,
                        createdAt: Date.now()
                    });
                    displayMessage(`'${title}' moved to your personal list.`);
                } catch (error) {
                    console.error("Error adding to personal list from request:", error);
                    displayMessage("Failed to add to personal list. Check console.", true);
                    return;
                }
            }
            
            // 2. Remove from request list
            try {
                await deleteDoc(doc(getPublicRequestsCollection(), requestId));
                // Realtime listener will handle the render update.
            } catch (error) {
                console.error("Error deleting request:", error);
                displayMessage("Failed to delete request. Check console.", true);
            }
        }

        // --- Video Player Logic ---
        
        // Function to render the dedicated video player page
        function renderPlayerView() {
            if (!currentlyPlaying || !currentlyPlaying.url) {
                videoPlayerView.innerHTML = `<div class="text-red-400 py-10 text-center">No video selected or link is invalid.</div>`;
                return;
            }

            const safeUrl = sanitizeUrl(currentlyPlaying.url);
            const videoId = extractYouTubeId(safeUrl);
            const embedUrl = videoId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0` : null;

            if (!embedUrl) {
                videoPlayerView.innerHTML = `
                    <div class="text-red-400 py-10 text-center">
                        <p class="text-xl mb-4">Cannot embed this video.</p>
                        <p class="text-sm text-gray-400">Only standard YouTube links are currently supported for playing on this page.</p>
                        <p class="text-sm text-gray-400 mt-2">Attempted URL: <a href="${safeUrl}" target="_blank" class="text-purple-400">${safeUrl}</a></p>
                        <button onclick="switchView('links')" class="mt-6 inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-red-300 bg-red-900/50 hover:bg-red-900 transition duration-150">
                            &larr; Back to Links
                        </button>
                    </div>`;
                return;
            }

            videoPlayerView.innerHTML = `
                <button onclick="switchView('links')" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-cyan-300 bg-cyan-900/50 hover:bg-cyan-900 transition duration-150 mb-6">
                    &larr; Back to Links
                </button>
                <h2 class="text-3xl font-bold text-white mb-4">${currentlyPlaying.title}</h2>
                <div class="video-container">
                    <iframe
                        src="${embedUrl}"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        loading="lazy"
                    ></iframe>
                </div>
            `;
        }

        // Function to initiate playback and switch to the player view
        window.playVideo = function(item) {
            currentlyPlaying = item;
            switchView('player');
        }

        // --- Video Links Rendering (Updated) ---

        function renderVideoLinks() {
            linksContainer.innerHTML = '';
            
            // Filter the current personalList state for items with a URL
            const links = personalList.filter(item => item.url && item.url.trim() !== '');

            if (links.length === 0) {
                linksContainer.innerHTML = `<div class="text-center text-gray-500 py-6">No saved links yet. Add items with a link in the 'Watch Lists' tab!</div>`;
                return;
            }

            links.forEach(item => {
                const safeUrl = sanitizeUrl(item.url);
                const videoId = extractYouTubeId(safeUrl);
                const canPlay = videoId !== null;
                const displayUrl = safeUrl.replace(/^(https?:\/\/(www\.)?)/, '').split('/')[0];

                // Use the grid layout to match the new header
                const linkElement = document.createElement('div');
                linkElement.className = 'grid grid-cols-12 items-center bg-gray-800 p-3 rounded-lg shadow-md transition duration-200 hover:bg-gray-700/80 border border-gray-700';

                // 1. Title (col-span-5)
                const titleDiv = document.createElement('div');
                titleDiv.className = 'col-span-5 min-w-0 pr-2';
                titleDiv.innerHTML = `<p class="text-sm font-bold text-white truncate">${item.title}</p>`;
                linkElement.appendChild(titleDiv);

                // 2. URL (col-span-4)
                const urlDiv = document.createElement('div');
                urlDiv.className = 'col-span-4 min-w-0 pr-2';
                const urlAnchor = document.createElement('a');
                urlAnchor.href = safeUrl;
                urlAnchor.target = '_blank';
                urlAnchor.rel = 'noopener noreferrer';
                urlAnchor.className = 'text-xs text-purple-400 hover:text-purple-300 truncate font-mono block';
                urlAnchor.textContent = displayUrl;
                urlDiv.appendChild(urlAnchor);
                linkElement.appendChild(urlDiv);

                // 3. Actions (col-span-3, right-aligned)
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'col-span-3 flex-shrink-0 flex items-center justify-end space-x-2';
                linkElement.appendChild(actionsDiv);
                
                // External Link Button (Always present)
                const externalLinkBtn = document.createElement('a');
                externalLinkBtn.href = safeUrl;
                externalLinkBtn.target = '_blank';
                externalLinkBtn.rel = 'noopener noreferrer';
                externalLinkBtn.title = 'Open Link in New Tab';
                externalLinkBtn.className = 'p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition duration-150';
                externalLinkBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>`;
                actionsDiv.appendChild(externalLinkBtn);

                // Play Button (Only for YouTube)
                if (canPlay) {
                    const playBtn = document.createElement('button');
                    playBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
                    playBtn.title = 'Play Video on Page';
                    playBtn.className = 'p-2 rounded-full bg-cyan-600 hover:bg-cyan-500 text-white transition duration-150 shadow-lg';
                    // Pass the entire item object to playVideo
                    playBtn.addEventListener('click', () => playVideo(item));
                    actionsDiv.appendChild(playBtn);
                }
                
                linksContainer.appendChild(linkElement);
            });
        }

        // --- Firebase Initialization and Auth ---

        async function initFirebase() {
            // CRITICAL: Log global variables to debug environment issues
            console.log("--- Firebase Init Check ---");
            console.log("App ID:", appId);
            console.log("Config loaded:", !!firebaseConfig);
            console.log("Auth Token present:", !!initialAuthToken);
            console.log("---------------------------");

            if (!firebaseConfig) {
                updateUserIdDisplay('ERROR: Config missing', false);
                loadingIndicator.classList.add('hidden'); // Hide spinner on config error
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                updateInteractiveElements(false); // Disable all UI elements immediately
                updateUserIdDisplay(null, false); // Set status to loading
                loadingIndicator.classList.remove('hidden'); // Show spinner

                // --- 1. Attempt Primary Sign-in ---
                if (initialAuthToken) {
                    try {
                        console.log("Attempting sign-in with custom token...");
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Primary sign-in successful.");
                    } catch (tokenError) {
                        console.error("Custom token sign-in failed. Falling back to anonymous sign-in.", tokenError);
                        await signInAnonymously(auth);
                        console.log("Anonymous fallback sign-in successful.");
                    }
                } else {
                    console.log("Custom token not provided. Signing in anonymously.");
                    await signInAnonymously(auth);
                    console.log("Anonymous sign-in successful.");
                }

                // --- 2. Set up Auth State Listener (This runs after sign-in attempts finish) ---
                onAuthStateChanged(auth, (user) => {
                    loadingIndicator.classList.add('hidden'); // CRITICAL: Hide loading spinner here
                    
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        
                        // CRITICAL: Auth successful, enable UI and listeners
                        console.log(`[AUTH READY] UI Enabled for User ID: ${currentUserId}`);
                        
                        updateUserIdDisplay(currentUserId, true);
                        updateInteractiveElements(true); 
                        
                        // Since listView is no longer hidden by default, we just ensure the correct view is showing
                        switchView(currentView); 
                        setupRealtimeListeners();
                    } else {
                        // This state means auth failed entirely or user signed out
                        console.error("[AUTH FAILED] User is null. All sign-in attempts failed or user signed out.");
                        updateUserIdDisplay(`ERROR: Auth Failed`, false);
                        updateInteractiveElements(false);
                        displayMessage("CRITICAL: Failed to sign in and enable UI.", true);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error (App or Firestore):", error);
                updateUserIdDisplay(`ERROR: Failed`, false);
                loadingIndicator.classList.add('hidden');
                updateInteractiveElements(false); 
                displayMessage("Initialization failed. Check console for Firebase errors.", true);
            }
        }

        function setupRealtimeListeners() {
            if (!isAuthReady) return;

            // 1. Personal Watch List Listener (Private Data)
            try {
                const personalQuery = query(getPersonalListCollection());
                onSnapshot(personalQuery, (snapshot) => {
                    personalList = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    // Re-render when data changes
                    renderList();
                }, (error) => {
                    console.error("Personal List Snapshot Error:", error);
                    displayMessage("Failed to load personal list data. (Snapshot Error)", true);
                });
            } catch (e) {
                console.error("Error setting up Personal List Listener (Missing UserId or DB):", e);
                displayMessage("Error setting up personal list listener.", true);
            }


            // 2. Public Watch Requests Listener (Public Data)
            try {
                const requestsQuery = query(getPublicRequestsCollection());
                onSnapshot(requestsQuery, (snapshot) => {
                    publicRequests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Re-render when data changes
                    renderRequests();
                }, (error) => {
                    console.error("Public Requests Snapshot Error:", error);
                    displayMessage("Failed to load public requests data. (Snapshot Error)", true);
                });
            } catch (e) {
                 console.error("Error setting up Public Requests Listener (Missing UserId or DB):", e);
                 displayMessage("Error setting up public requests listener.", true);
            }
        }


        // --- Event Listeners and Initial Load ---
        
        window.onload = () => {
            initFirebase();
            
            // Navigation Listeners
            listViewBtn.addEventListener('click', () => switchView('list'));
            linksViewBtn.addEventListener('click', () => switchView('links'));

            // Personal List Listeners
            addItemBtn.addEventListener('click', addItem); 
            itemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { addItem(); } });
            urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { addItem(); } });
            clearAllBtn.addEventListener('click', clearAll);

            // Request List Listeners
            addRequestBtn.addEventListener('click', addRequest);
            requestInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { addRequest(); } });
            suggesterInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { addRequest(); } });
        }

    </script>
</body>
</html>
